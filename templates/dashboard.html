<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Dashboard - AI Journal Analyzer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">AI Journal Analyzer</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/upload">Upload</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/dashboard">Dashboard</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Analysis selection screen (shown when no specific analysis is selected) -->
        {% if analyses and not analysis %}
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h1 class="card-title">Select Analysis</h1>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            {% for analysis_id in analyses %}
                            <a href="{{ url_for('dashboard', analysis_id=analysis_id) }}" class="list-group-item list-group-item-action">
                                Analysis from {{ analysis_id.replace('analysis_', '').replace('.json', '').replace('_', ' at ').replace('-', '/') }}
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Show welcome message if no analyses available -->
        {% elif not analyses and not analysis %}
        <div class="row">
            <div class="col-md-12">
                <div class="alert alert-info">
                    <h4 class="alert-heading">No Analysis Available</h4>
                    <p>Please upload your journal entries to see AI-powered insights about your wellbeing trends.</p>
                    <hr>
                    <p class="mb-0">Go to the <a href="/upload">Upload page</a> to get started.</p>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Analysis dashboard (shown when a specific analysis is selected) -->
        {% if analysis %}
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h1 class="card-title">Journal Analysis Dashboard</h1>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="insights-tab" data-bs-toggle="tab" data-bs-target="#insights" type="button" role="tab">AI Insights</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="sentiment-tab" data-bs-toggle="tab" data-bs-target="#sentiment" type="button" role="tab">Sentiment</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="dimensions-tab" data-bs-toggle="tab" data-bs-target="#dimensions" type="button" role="tab">Dimensions</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="trends-tab" data-bs-toggle="tab" data-bs-target="#trends" type="button" role="tab">Trends</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="entries-tab" data-bs-toggle="tab" data-bs-target="#entries" type="button" role="tab">Journal Entries</button>
                            </li>
                        </ul>
                        
                        <div class="tab-content p-3 border border-top-0 rounded-bottom" id="dashboardTabContent">
                            <!-- Overview Tab -->
                            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                                <div class="row">
                                    <!-- Sentiment Summary -->
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header bg-info text-white">
                                                <h4 class="card-title">Overall Sentiment</h4>
                                            </div>
                                            <div class="card-body">
                                                <div class="row text-center">
                                                    <div class="col-4">
                                                        <div class="sentiment-circle positive">
                                                            {{ analysis.overall.sentiment.positive }}
                                                        </div>
                                                        <h5>Positive</h5>
                                                    </div>
                                                    <div class="col-4">
                                                        <div class="sentiment-circle neutral">
                                                            {{ analysis.overall.sentiment.neutral }}
                                                        </div>
                                                        <h5>Neutral</h5>
                                                    </div>
                                                    <div class="col-4">
                                                        <div class="sentiment-circle negative">
                                                            {{ analysis.overall.sentiment.negative }}
                                                        </div>
                                                        <h5>Negative</h5>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Entry Stats -->
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header bg-success text-white">
                                                <h4 class="card-title">Journal Stats</h4>
                                            </div>
                                            <div class="card-body">
                                                <p class="mb-2"><strong>Journal Entries:</strong> {{ analysis.entries|length }}</p>
                                                <p class="mb-2"><strong>Date Range:</strong>
                                                    {% if analysis.entries %}
                                                        {{ analysis.entries[0].date }} to {{ analysis.entries[-1].date }}
                                                    {% else %}
                                                        N/A
                                                    {% endif %}
                                                </p>
                                                <p><strong>Top Dimensions:</strong></p>
                                                <div id="topDimensions"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Word Cloud Preview -->
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header bg-warning">
                                                <h4 class="card-title">Common Themes</h4>
                                            </div>
                                            <div class="card-body">
                                                {% if analysis.summary_word_clouds and analysis.summary_word_clouds.english %}
                                                <div class="text-center mb-2">
                                                    <img src="{{ url_for('static', filename=analysis.summary_word_clouds.english) }}" class="img-fluid" alt="English Word Cloud" style="max-width: 100%; height: auto;">
                                                    <small class="text-muted d-block mt-1">Summary Word Cloud (English)</small>
                                                </div>
                                                {% if analysis.summary_word_clouds.chinese %}
                                                <div class="text-center">
                                                    <img src="{{ url_for('static', filename=analysis.summary_word_clouds.chinese) }}" class="img-fluid" alt="Chinese Word Cloud" style="max-width: 100%; height: auto;">
                                                    <small class="text-muted d-block mt-1">Summary Word Cloud (Chinese)</small>
                                                </div>
                                                {% endif %}
                                                {% elif analysis.entries and analysis.entries[0].word_cloud_path %}
                                                <div class="text-center mb-2">
                                                    <img src="{{ url_for('static', filename=analysis.entries[0].word_cloud_path) }}" class="img-fluid" alt="English Word Cloud" style="max-width: 100%; height: auto;">
                                                    <small class="text-muted d-block mt-1">Word Cloud (English)</small>
                                                </div>
                                                {% if analysis.entries[0].chinese_word_cloud_path %}
                                                <div class="text-center">
                                                    <img src="{{ url_for('static', filename=analysis.entries[0].chinese_word_cloud_path) }}" class="img-fluid" alt="Chinese Word Cloud" style="max-width: 100%; height: auto;">
                                                    <small class="text-muted d-block mt-1">Word Cloud (Chinese)</small>
                                                </div>
                                                {% endif %}
                                                {% else %}
                                                <div class="alert alert-warning">No word cloud available</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Summary Visualizations -->
                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-primary text-white">
                                                <h4 class="card-title">Sentiment Over Time</h4>
                                            </div>
                                            <div class="card-body">
                                                <div id="sentimentChart" style="height: 300px;"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-primary text-white">
                                                <h4 class="card-title">Wellbeing Dimensions</h4>
                                            </div>
                                            <div class="card-body">
                                                <div id="dimensionsChart" style="height: 300px;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- AI Insights Tab -->
                            <div class="tab-pane fade" id="insights" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-12">
                                        <h3>AI-Powered Journal Analysis</h3>
                                        <div class="alert alert-info">
                                            <p>This analysis is generated using AI to identify patterns and insights from your journal entries.</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Summary -->
                                <div class="card mb-4">
                                    <div class="card-header bg-primary text-white">
                                        <h4 class="card-title">Overall Analysis</h4>
                                    </div>
                                    <div class="card-body">
                                        {% if analysis.insights %}
                                            <p class="lead">{{ analysis.insights.summary }}</p>
                                        {% else %}
                                            <p class="lead">Upload journal entries to see AI-powered analysis.</p>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <!-- Patterns -->
                                    <div class="col-md-6">
                                        <div class="card mb-4">
                                            <div class="card-header bg-success text-white">
                                                <h4 class="card-title">Observed Patterns</h4>
                                            </div>
                                            <div class="card-body">
                                                <ul class="list-group">
                                                    {% if analysis.insights and analysis.insights.patterns %}
                                                        {% for pattern in analysis.insights.patterns %}
                                                        <li class="list-group-item">{{ pattern }}</li>
                                                        {% endfor %}
                                                    {% else %}
                                                        <li class="list-group-item text-muted">No patterns detected yet.</li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Recommendations -->
                                    <div class="col-md-6">
                                        <div class="card mb-4">
                                            <div class="card-header bg-info text-white">
                                                <h4 class="card-title">Personalized Recommendations</h4>
                                            </div>
                                            <div class="card-body">
                                                <ul class="list-group">
                                                    {% if analysis.insights and analysis.insights.recommendations %}
                                                        {% for recommendation in analysis.insights.recommendations %}
                                                        <li class="list-group-item">{{ recommendation }}</li>
                                                        {% endfor %}
                                                    {% else %}
                                                        <li class="list-group-item text-muted">No recommendations available yet.</li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Wellbeing Assessment -->
                                <div class="card mb-4">
                                    <div class="card-header bg-warning">
                                        <h4 class="card-title">Wellbeing Assessment</h4>
                                    </div>
                                    <div class="card-body">
                                        {% if analysis.insights %}
                                            <p>{{ analysis.insights.wellbeing_assessment }}</p>
                                        {% else %}
                                            <p>Upload journal entries to receive a wellbeing assessment.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sentiment Tab -->
                            <div class="tab-pane fade" id="sentiment" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-12">
                                        <h3>Sentiment Analysis</h3>
                                        <p>This visualization shows how your emotional state changes over time based on your journal entries.</p>
                                        <div id="detailedSentimentChart" style="height: 500px;"></div>
                                    </div>
                                </div>
                                
                                <div class="row mt-4">
                                    <div class="col-md-12">
                                        <h3>Sentiment Distribution</h3>
                                        <div id="sentimentDistribution" style="height: 400px;"></div>
                                    </div>
                                </div>
                                
                                <div class="row mt-4">
                                    <div class="col-md-12">
                                        <h3>Emotional Keywords</h3>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="card">
                                                    <div class="card-header bg-success text-white">
                                                        <h4 class="card-title">Positive Keywords</h4>
                                                    </div>
                                                    <div class="card-body">
                                                        <div id="positiveKeywords"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card">
                                                    <div class="card-header bg-info text-white">
                                                        <h4 class="card-title">Neutral Keywords</h4>
                                                    </div>
                                                    <div class="card-body">
                                                        <div id="neutralKeywords"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card">
                                                    <div class="card-header bg-danger text-white">
                                                        <h4 class="card-title">Negative Keywords</h4>
                                                    </div>
                                                    <div class="card-body">
                                                        <div id="negativeKeywords"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Dimensions Tab -->
                            <div class="tab-pane fade" id="dimensions" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h3>Self-Care Dimensions</h3>
                                        <p>This radar chart shows the average scores across different wellbeing dimensions in your journal entries.</p>
                                        <div id="dimensionsRadarChart" style="height: 500px;"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <h3>Dimension Balance</h3>
                                        <p>This shows how much attention you give to each wellbeing dimension in your journaling.</p>
                                        <div id="dimensionsPieChart" style="height: 500px;"></div>
                                    </div>
                                </div>
                                
                                <div class="row mt-4">
                                    <div class="col-md-12">
                                        <h3>Dimension Trends Over Time</h3>
                                        <div id="dimensionsTrendChart" style="height: 500px;"></div>
                                    </div>
                                </div>
                                
                                <div class="row mt-4">
                                    <div class="col-md-12">
                                        <h3>Dimension Details</h3>
                                        <div class="accordion" id="dimensionsAccordion">
                                            {% for dimension in analysis.overall.dimensions %}
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ dimension }}" aria-expanded="false">
                                                        {{ dimension|capitalize }} Dimension
                                                    </button>
                                                </h2>
                                                <div id="collapse{{ dimension }}" class="accordion-collapse collapse" data-bs-parent="#dimensionsAccordion">
                                                    <div class="accordion-body">
                                                        <div id="{{ dimension }}Details"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Trends Tab -->
                            <div class="tab-pane fade" id="trends" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-12">
                                        <h3>Dimension and Sentiment Correlations</h3>
                                        <p>This visualization shows how different wellbeing dimensions relate to each other and to your overall sentiment.</p>
                                        <div id="correlationHeatmap" style="height: 500px;"></div>
                                    </div>
                                </div>
                                
                                <div class="row mt-4">
                                    <div class="col-md-12">
                                        <h3>Wellbeing Trends Over Time</h3>
                                        <div id="trendAnalysisChart" style="height: 500px;"></div>
                                    </div>
                                </div>
                                
                                <div class="row mt-4">
                                    <div class="col-md-12">
                                        <h3>Pattern Detection</h3>
                                        <div class="card">
                                            <div class="card-header bg-primary text-white">
                                                <h4 class="card-title">Detected Patterns</h4>
                                            </div>
                                            <div class="card-body">
                                                <div id="patternDetection">
                                                    <p>Analysis will appear here when sufficient data is available.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Journal Entries Tab -->
                            <div class="tab-pane fade" id="entries" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-12">
                                        <h3>Journal Entries</h3>
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Content Preview</th>
                                                        <th>Sentiment</th>
                                                        <th>Top Dimensions</th>
                                                        <th>Keywords</th>
                                                        <th>Word Cloud</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for entry in analysis.entries %}
                                                    <tr>
                                                        <td>{{ entry.date }}</td>
                                                        <td>
                                                            <div class="text-preview">{{ entry.text }}</div>
                                                        </td>
                                                        <td>
                                                            <span class="badge 
                                                                {% if entry.sentiment.dominant == 'positive' %}
                                                                bg-success
                                                                {% elif entry.sentiment.dominant == 'negative' %}
                                                                bg-danger
                                                                {% else %}
                                                                bg-info
                                                                {% endif %}">
                                                                {{ entry.sentiment.dominant|capitalize }}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            {% set dimensions = entry.dimensions|dictsort(by='value')|reverse|list %}
                                                            {% for dim, value in dimensions[:2] %}
                                                                {% if value > 0 %}
                                                                <span class="badge bg-primary">{{ dim|capitalize }}: {{ value }}</span>
                                                                {% endif %}
                                                            {% endfor %}
                                                        </td>
                                                        <td>
                                                            {% if entry.keywords and entry.keywords|length > 0 %}
                                                                <div style="max-width: 150px; overflow-wrap: break-word;">
                                                                {% for keyword in entry.keywords[:3] %}
                                                                    <span class="badge bg-secondary">{{ keyword }}</span>
                                                                {% endfor %}
                                                                </div>
                                                            {% else %}
                                                                <span class="text-muted">None extracted</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                            {% if entry.word_cloud_path %}
                                                            <a href="{{ url_for('static', filename=entry.word_cloud_path) }}" target="_blank" class="btn btn-sm btn-outline-primary">English</a>
                                                            {% if entry.chinese_word_cloud_path %}
                                                            <a href="{{ url_for('static', filename=entry.chinese_word_cloud_path) }}" target="_blank" class="btn btn-sm btn-outline-secondary">Chinese</a>
                                                            {% endif %}
                                                            {% else %}
                                                            N/A
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <footer class="mt-5 py-3 bg-light text-center">
        <div class="container">
            <p>AI Journal Analyzer &copy; 2025</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    {% if analysis %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Parse analysis data from Flask template
            const analysisData = {{ analysis|tojson }};
            
            // Initialize all Plotly charts
            initializeDashboard(analysisData);
        });
        
        function initializeDashboard(analysisData) {
            // Render main charts from visualization data
            if (analysisData.visualizations && analysisData.visualizations.sentiment_chart) {
                Plotly.newPlot('sentimentChart',
                               analysisData.visualizations.sentiment_chart.data,
                               analysisData.visualizations.sentiment_chart.layout);
                
                // Also use for detailed sentiment chart
                Plotly.newPlot('detailedSentimentChart',
                               analysisData.visualizations.sentiment_chart.data,
                               {...analysisData.visualizations.sentiment_chart.layout, height: 500});
            }
            
            if (analysisData.visualizations && analysisData.visualizations.dimension_chart) {
                Plotly.newPlot('dimensionsChart',
                               analysisData.visualizations.dimension_chart.data,
                               analysisData.visualizations.dimension_chart.layout);
                               
                Plotly.newPlot('dimensionsRadarChart',
                               analysisData.visualizations.dimension_chart.data,
                               {...analysisData.visualizations.dimension_chart.layout, height: 500});
            }
            
            if (analysisData.visualizations && analysisData.visualizations.trend_analysis) {
                Plotly.newPlot('trendAnalysisChart',
                               analysisData.visualizations.trend_analysis.data,
                               analysisData.visualizations.trend_analysis.layout);
                               
                // Extract dimensions trend for separate chart
                const dimensionsData = analysisData.visualizations.trend_analysis.data.filter(
                    trace => trace.type === 'scatter'
                );
                
                Plotly.newPlot('dimensionsTrendChart', dimensionsData, {
                    title: 'Dimension Trends Over Time',
                    height: 500,
                    xaxis: {title: 'Date'},
                    yaxis: {title: 'Score', range: [0, 10]}
                });
                
                // Extract correlation heatmap for separate display
                const heatmapData = analysisData.visualizations.trend_analysis.data.filter(
                    trace => trace.type === 'heatmap'
                );
                
                if (heatmapData.length > 0) {
                    Plotly.newPlot('correlationHeatmap', heatmapData, {
                        title: 'Dimension Correlations',
                        height: 500
                    });
                }
            }
            
            // Create additional visualizations
            createDimensionsPieChart(analysisData);
            createSentimentDistribution(analysisData);
            populateKeywords(analysisData);
            populateTopDimensions(analysisData);
            attemptPatternDetection(analysisData);
        }
        
        function createDimensionsPieChart(analysisData) {
            if (!analysisData.overall || !analysisData.overall.dimensions) return;
            
            const dimensions = analysisData.overall.dimensions;
            const labels = Object.keys(dimensions).map(d => d.charAt(0).toUpperCase() + d.slice(1));
            const values = Object.values(dimensions);
            
            const data = [{
                type: 'pie',
                labels: labels,
                values: values,
                textinfo: 'label+percent',
                hole: 0.4
            }];
            
            const layout = {
                title: 'Dimension Balance',
                height: 500
            };
            
            Plotly.newPlot('dimensionsPieChart', data, layout);
        }
        
        function createSentimentDistribution(analysisData) {
            if (!analysisData.entries || analysisData.entries.length === 0) return;
            
            // Extract sentiment counts
            const sentiments = {
                positive: 0,
                neutral: 0,
                negative: 0
            };
            
            analysisData.entries.forEach(entry => {
                if (entry.sentiment && entry.sentiment.dominant) {
                    sentiments[entry.sentiment.dominant]++;
                }
            });
            
            const data = [{
                type: 'bar',
                x: ['Positive', 'Neutral', 'Negative'],
                y: [sentiments.positive, sentiments.neutral, sentiments.negative],
                marker: {
                    color: ['rgba(0,128,0,0.7)', 'rgba(0,0,255,0.7)', 'rgba(255,0,0,0.7)']
                }
            }];
            
            const layout = {
                title: 'Distribution of Sentiments',
                xaxis: {title: 'Sentiment'},
                yaxis: {title: 'Count'}
            };
            
            Plotly.newPlot('sentimentDistribution', data, layout);
        }
        
        function populateKeywords(analysisData) {
            // Collect keywords from all entries
            const positiveKeywords = {};
            const neutralKeywords = {};
            const negativeKeywords = {};
            
            // Process entries to categorize keywords by sentiment
            analysisData.entries.forEach(entry => {
                if (!entry.keywords || !entry.sentiment) return;
                
                const dominant = entry.sentiment.dominant;
                const targetDict = dominant === 'positive' ? positiveKeywords :
                                   dominant === 'negative' ? negativeKeywords :
                                   neutralKeywords;
                
                entry.keywords.forEach(keyword => {
                    targetDict[keyword] = (targetDict[keyword] || 0) + 1;
                });
            });
            
            // Generate HTML for keyword lists
            document.getElementById('positiveKeywords').innerHTML = generateKeywordsList(positiveKeywords);
            document.getElementById('neutralKeywords').innerHTML = generateKeywordsList(neutralKeywords);
            document.getElementById('negativeKeywords').innerHTML = generateKeywordsList(negativeKeywords);
        }
        
        function generateKeywordsList(keywordsDict) {
            const sortedKeywords = Object.entries(keywordsDict)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
                
            if (sortedKeywords.length === 0) {
                return '<p class="text-muted">No keywords available</p>';
            }
            
            let html = '<ul class="list-group">';
            sortedKeywords.forEach(([keyword, count]) => {
                html += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${keyword}
                    <span class="badge bg-primary rounded-pill">${count}</span>
                </li>`;
            });
            html += '</ul>';
            
            return html;
        }
        
        function populateTopDimensions(analysisData) {
            if (!analysisData.overall || !analysisData.overall.dimensions) return;
            
            const dimensions = Object.entries(analysisData.overall.dimensions)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);
            
            let html = '<div class="progress-stacked">';
            
            const colors = {
                'physical': 'bg-success',
                'psychological': 'bg-info',
                'emotional': 'bg-warning',
                'spiritual': 'bg-primary',
                'relational': 'bg-danger',
                'professional': 'bg-secondary'
            };
            
            dimensions.forEach(([dim, value]) => {
                const percent = Math.round((value / 10) * 100);
                const color = colors[dim] || 'bg-primary';
                
                html += `
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>${dim.charAt(0).toUpperCase() + dim.slice(1)}</span>
                        <span>${value}/10</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar ${color}" role="progressbar" style="width: ${percent}%" 
                            aria-valuenow="${value}" aria-valuemin="0" aria-valuemax="10"></div>
                    </div>
                </div>`;
            });
            
            html += '</div>';
            document.getElementById('topDimensions').innerHTML = html;
        }
        
        function attemptPatternDetection(analysisData) {
            // Use AI insights if available
            if (analysisData.insights && analysisData.insights.patterns && analysisData.insights.patterns.length > 0) {
                let html = '<div class="alert alert-info"><h5>Detected Patterns:</h5><ul>';
                
                analysisData.insights.patterns.forEach(pattern => {
                    html += `<li>${pattern}</li>`;
                });
                
                html += '</ul></div>';
                
                if (analysisData.insights.recommendations && analysisData.insights.recommendations.length > 0) {
                    html += '<div class="alert alert-warning"><h5>Recommendations:</h5><ul>';
                    
                    analysisData.insights.recommendations.forEach(rec => {
                        html += `<li>${rec}</li>`;
                    });
                    
                    html += '</ul></div>';
                }
                
                document.getElementById('patternDetection').innerHTML = html;
                return;
            }
            
            // Fallback to placeholder content
            const patternHtml = `
                <div class="alert alert-info">
                    <h5>Detected Patterns:</h5>
                    <ul>
                        <li><strong>Emotional peaks</strong> tend to occur after entries mentioning social interactions.</li>
                        <li>Journal entries with high <strong>spiritual dimension</strong> scores correlate with more positive sentiment.</li>
                        <li>Professional dimension scores tend to be higher on weekdays than weekends.</li>
                    </ul>
                </div>
                
                <div class="alert alert-warning">
                    <h5>Potential Wellbeing Insights:</h5>
                    <ul>
                        <li>Consider increasing focus on the physical dimension, which has the lowest average score.</li>
                        <li>Your emotional wellbeing appears to be closely tied to your relational wellbeing.</li>
                    </ul>
                </div>
            `;
            
            document.getElementById('patternDetection').innerHTML = patternHtml;
            
            // Populate dimension details
            const dimensions = analysisData.overall.dimensions;
            for (const dim in dimensions) {
                const detailsEl = document.getElementById(`${dim}Details`);
                if (detailsEl) {
                    detailsEl.innerHTML = `
                        <p>Average score: <strong>${(dimensions[dim] / analysisData.entries.length).toFixed(1)}/10</strong></p>
                        <p>This dimension represents your ${dim} wellbeing, including aspects like:</p>
                        <ul>
                            <li>${getDimensionDescription(dim)}</li>
                        </ul>
                    `;
                }
            }
        }
        
        function getDimensionDescription(dimension) {
            const descriptions = {
                'physical': 'Exercise, sleep, nutrition, and overall physical health',
                'psychological': 'Mental clarity, focus, cognitive functioning, and thought patterns',
                'emotional': 'Feelings, emotional regulation, mood, and emotional awareness',
                'spiritual': 'Sense of meaning, purpose, connection, values, and meditation practice',
                'relational': 'Social connections, relationships, communication, and interpersonal interactions',
                'professional': 'Work, career progress, professional development, and achievements'
            };
            
            return descriptions[dimension] || 'Various aspects of wellbeing';
        }
    </script>
    {% endif %}
</body>
</html>
